<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Fox CDN - HLS Streaming Demo</title>
    <link rel="stylesheet" href="assets/styles.css" />
    <script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
    <style>
      .demo-container {
        max-width: 800px;
        margin: 100px auto;
        padding: 32px;
      }

      .player-container {
        position: relative;
        background: var(--bg-darker);
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--border);
        margin-bottom: 24px;
      }

      .hls-video {
        width: 100%;
        height: auto;
        display: block;
      }

      .controls-panel {
        padding: 20px;
        background: var(--bg-card);
        border-radius: 12px;
        margin-bottom: 16px;
      }

      .control-group {
        margin-bottom: 16px;
      }

      .control-label {
        font-size: 13px;
        font-weight: 600;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 8px;
        display: block;
      }

      select,
      button {
        padding: 10px 16px;
        background: var(--bg-darker);
        border: 1px solid var(--border);
        border-radius: 8px;
        color: var(--text-primary);
        font-size: 14px;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      select:hover,
      button:hover {
        border-color: var(--primary);
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 16px;
        padding: 20px;
        background: var(--bg-card);
        border-radius: 12px;
      }

      .stat-box {
        text-align: center;
      }

      .stat-value {
        font-size: 24px;
        font-weight: 800;
        color: var(--primary);
        margin-bottom: 4px;
      }

      .stat-label {
        font-size: 12px;
        color: var(--text-muted);
      }

      .info-panel {
        padding: 16px;
        background: rgba(255, 107, 53, 0.1);
        border-left: 3px solid var(--primary);
        border-radius: 8px;
        margin-top: 24px;
      }

      .info-title {
        font-weight: 700;
        color: var(--primary);
        margin-bottom: 8px;
      }
    </style>
  </head>
  <body>
    <div class="demo-container">
      <h1
        style="
          font-size: 48px;
          font-weight: 800;
          margin-bottom: 16px;
          text-align: center;
        "
      >
        HLS Streaming Demo
      </h1>
      <p
        style="
          text-align: center;
          color: var(--text-secondary);
          margin-bottom: 48px;
        "
      >
        Adaptive bitrate streaming com HLS.js - profissional como Cloudflare
        Stream
      </p>

      <div class="player-container">
        <video id="hls-video" class="hls-video" controls poster=""></video>
      </div>

      <div class="controls-panel">
        <div class="control-group">
          <label class="control-label">VÃ­deo</label>
          <select id="video-selector">
            <option value="">Selecione um vÃ­deo...</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label">Qualidade</label>
          <select id="quality-selector" disabled>
            <option value="-1">Auto (Adaptativo)</option>
          </select>
        </div>

        <div class="control-group">
          <label class="control-label">AÃ§Ãµes</label>
          <button onclick="toggleStats()">ðŸ“Š Toggle Stats</button>
          <button onclick="downloadManifest()">ðŸ“„ Download Manifest</button>
        </div>
      </div>

      <div class="stats-grid" id="stats-panel" style="display: none">
        <div class="stat-box">
          <div class="stat-value" id="current-quality">-</div>
          <div class="stat-label">QUALIDADE ATUAL</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="buffer-length">-</div>
          <div class="stat-label">BUFFER (s)</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="dropped-frames">0</div>
          <div class="stat-label">FRAMES PERDIDOS</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="bandwidth">-</div>
          <div class="stat-label">BANDWIDTH</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="codec-info">-</div>
          <div class="stat-label">CODEC</div>
        </div>
        <div class="stat-box">
          <div class="stat-value" id="load-time">-</div>
          <div class="stat-label">LOAD TIME (ms)</div>
        </div>
      </div>

      <div class="info-panel">
        <div class="info-title">ðŸ’¡ Como funciona o HLS Adaptive Streaming</div>
        <ul
          style="
            margin: 0;
            padding-left: 20px;
            color: var(--text-secondary);
            line-height: 1.8;
          "
        >
          <li>
            O vÃ­deo Ã© dividido em mÃºltiplas qualidades (360p, 480p, 720p, 1080p)
          </li>
          <li>Cada qualidade Ã© segmentada em chunks de 4 segundos</li>
          <li>O player monitora a velocidade da conexÃ£o em tempo real</li>
          <li>Automaticamente seleciona a melhor qualidade disponÃ­vel</li>
          <li>Reduz buffering e melhora experiÃªncia do usuÃ¡rio</li>
        </ul>
      </div>
    </div>

    <script src="assets/script.js"></script>
    <script>
      let hls;
      let allVideos = [];
      let statsInterval;

      // Load videos
      async function loadVideos() {
        const res = await fetch("../api/videos.json");
        const data = await res.json();
        allVideos = data.videos;

        const selector = document.getElementById("video-selector");
        allVideos.forEach((video) => {
          const option = document.createElement("option");
          option.value = video.slug;
          option.textContent = video.title;
          selector.appendChild(option);
        });
      }

      // Initialize HLS player
      function initHLS(videoUrl, posterUrl) {
        const video = document.getElementById("hls-video");
        video.poster = posterUrl;

        if (hls) {
          hls.destroy();
        }

        if (Hls.isSupported()) {
          hls = new Hls({
            debug: false,
            enableWorker: true,
            lowLatencyMode: false,
            backBufferLength: 90,
          });

          hls.loadSource(videoUrl);
          hls.attachMedia(video);

          // Events
          hls.on(Hls.Events.MANIFEST_PARSED, onManifestParsed);
          hls.on(Hls.Events.LEVEL_SWITCHED, onLevelSwitched);
          hls.on(Hls.Events.FRAG_LOADED, onFragLoaded);
          hls.on(Hls.Events.ERROR, onError);

          // Start stats monitoring
          startStatsMonitoring();
        } else if (video.canPlayType("application/vnd.apple.mpegurl")) {
          // Safari native HLS
          video.src = videoUrl;
        }
      }

      function onManifestParsed(event, data) {
        console.log(
          "Manifest loaded, found " + data.levels.length + " quality levels"
        );

        const qualitySelector = document.getElementById("quality-selector");
        qualitySelector.innerHTML =
          '<option value="-1">Auto (Adaptativo)</option>';
        qualitySelector.disabled = false;

        hls.levels.forEach((level, index) => {
          const option = document.createElement("option");
          option.value = index;
          option.textContent = `${level.height}p (${(
            level.bitrate / 1000
          ).toFixed(0)} kbps)`;
          qualitySelector.appendChild(option);
        });

        qualitySelector.onchange = (e) => {
          hls.currentLevel = parseInt(e.target.value);
        };
      }

      function onLevelSwitched(event, data) {
        const level = hls.levels[data.level];
        document.getElementById("current-quality").textContent =
          level.height + "p";
        document.getElementById("codec-info").textContent =
          level.codecSet || "H.264";

        console.log("Quality switched to:", level.height + "p");
      }

      function onFragLoaded(event, data) {
        const loadTime =
          data.frag.stats.loading.end - data.frag.stats.loading.start;
        document.getElementById("load-time").textContent = loadTime.toFixed(0);
      }

      function onError(event, data) {
        console.error("HLS error:", data);
        if (data.fatal) {
          switch (data.type) {
            case Hls.ErrorTypes.NETWORK_ERROR:
              console.log("Network error, trying to recover...");
              hls.startLoad();
              break;
            case Hls.ErrorTypes.MEDIA_ERROR:
              console.log("Media error, trying to recover...");
              hls.recoverMediaError();
              break;
            default:
              console.log("Fatal error, destroying player");
              hls.destroy();
              break;
          }
        }
      }

      function startStatsMonitoring() {
        if (statsInterval) clearInterval(statsInterval);

        statsInterval = setInterval(() => {
          if (!hls) return;

          const video = document.getElementById("hls-video");
          const buffered = video.buffered;

          if (buffered.length > 0) {
            const bufferLength =
              buffered.end(buffered.length - 1) - video.currentTime;
            document.getElementById("buffer-length").textContent =
              bufferLength.toFixed(1);
          }

          // Bandwidth estimate
          const bandwidth = hls.bandwidthEstimate;
          if (bandwidth) {
            document.getElementById("bandwidth").textContent =
              (bandwidth / 1000000).toFixed(2) + " Mbps";
          }

          // Dropped frames
          if (video.webkitDecodedFrameCount) {
            const dropped = video.webkitDroppedFrameCount || 0;
            document.getElementById("dropped-frames").textContent = dropped;
          }
        }, 1000);
      }

      function toggleStats() {
        const panel = document.getElementById("stats-panel");
        panel.style.display = panel.style.display === "none" ? "grid" : "none";
      }

      function downloadManifest() {
        if (!hls) return;

        const selector = document.getElementById("video-selector");
        const slug = selector.value;
        if (!slug) return;

        const manifestUrl = `https://trebla-io.github.io/fox-cdn/videos/${slug}/master.m3u8`;
        window.open(manifestUrl, "_blank");
      }

      // Video selector change
      document
        .getElementById("video-selector")
        .addEventListener("change", (e) => {
          const slug = e.target.value;
          if (!slug) return;

          const video = allVideos.find((v) => v.slug === slug);
          if (!video) return;

          // For now, use regular MP4 (replace with HLS when available)
          // const hlsUrl = `https://trebla-io.github.io/fox-cdn/videos/${slug}/master.m3u8`;
          const mp4Url = video.sources[0].url;
          const posterUrl = video.thumbnail.url;

          // Uncomment when HLS is generated:
          // initHLS(hlsUrl, posterUrl);

          // Temporary: use MP4
          const videoEl = document.getElementById("hls-video");
          videoEl.src = mp4Url;
          videoEl.poster = posterUrl;
        });

      // Initialize
      loadVideos();
    </script>
  </body>
</html>
